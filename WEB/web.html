<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng S·∫Øp X·∫øp V·∫≠t Th·ªÉ T·ª± ƒê·ªông</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            text-transform: uppercase;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-title {
            font-size: 18px;
            font-weight: bold;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-item label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .config-item input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .config-item input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn-connect {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-connect:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-connect:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-disconnected {
            background: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }

        .status-connected {
            background: #efe;
            color: #3c3;
            border: 2px solid #cfc;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .left-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #dee2e6;
        }

        .status-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .status-box.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .status-box h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            font-size: 18px;
            font-weight: bold;
        }

        .color-display {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            border: 5px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            background: #f0f0f0;
        }

        .button-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #f39c12;
            color: white;
        }

        .btn-export:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .right-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #dee2e6;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .chart-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .pie-chart {
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border-radius: 50%;
            position: relative;
        }
        #pieChart{
        display: block;
        margin: 0 auto;
        }

        .stats-list {
            list-style: none;
            padding: 0;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid;
            font-size: 16px;
            font-weight: bold;
        }

        .stats-item.red { border-left-color: #e74c3c; }
        .stats-item.green { border-left-color: #2ecc71; }
        .stats-item.blue { border-left-color: #3498db; }
        .stats-item.yellow { border-left-color: #f1c40f; }
        .stats-item.black { border-left-color: #34495e; }
        .stats-item.white { border-left-color: #ecf0f1; border: 2px solid #bdc3c7; }
        .stats-item.total { border-left-color: #9b59b6; background: #e8daef; }

        .color-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .robot-animation {
            width: 100%;
            height: 200px;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #2196f3;
        }

        .conveyor-belt {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(
                90deg,
                #78909c 0px,
                #78909c 20px,
                #607d8b 20px,
                #607d8b 40px
            );
            animation: moveBelt 2s linear infinite;
        }

        @keyframes moveBelt {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }

        .robot-arm {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 120px;
        }

        .arm-base {
            width: 60px;
            height: 20px;
            background: #424242;
            margin: 0 auto;
            border-radius: 5px;
        }

        .arm-segment {
            width: 15px;
            height: 80px;
            background: linear-gradient(180deg, #616161 0%, #424242 100%);
            margin: 0 auto;
            border-radius: 5px;
            position: relative;
        }

        .arm-gripper {
            width: 40px;
            height: 30px;
            background: #ff9800;
            margin: 0 auto;
            border-radius: 5px;
            position: relative;
        }

        .object {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            bottom: 50px;
            left: 10%;
            border: 3px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            background: #ccc;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ H·ªá Th·ªëng T·ª± ƒê·ªông Nh·∫≠n Di·ªán v√† S·∫Øp X·∫øp V·∫≠t Th·ªÉ D·ª±a Tr√™n M√†u S·∫Øc üé®</h1>
        
        <!-- Tr·∫°ng th√°i k·∫øt n·ªëi Firebase -->
        <div class="config-section">
            <div class="connection-status status-disconnected" id="connectionStatus">
                <span class="status-dot" style="background: #c33;"></span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="robot-animation">
                    <div class="robot-arm">
                        <div class="arm-base"></div>
                        <div class="arm-segment"></div>
                        <div class="arm-gripper"></div>
                    </div>
                    <div class="object" id="movingObject"></div>
                    <div class="conveyor-belt"></div>
                </div>

                <div class="status-box" id="detectionStatus">
                    <h3>üîç PH√ÅT HI·ªÜN C√ì V·∫¨T</h3>
                </div>

                <div class="info-box">
                    <span>üì¶ V·∫¨T S·ªê: </span>
                    <span id="objectNumber">0</span>
                </div>

                <div class="info-box">
                    <span>üé® M√ÄU C·ª¶A V·∫¨T: </span>
                    <span id="objectColor" style="font-weight: bold;">---</span>
                </div>

                <div class="color-display" id="colorDisplay"></div>

                <div class="info-box" style="text-align: center; font-size: 20px;">
                    <span>‚è±Ô∏è TH·ªúI GIAN S·∫ÆP X·∫æP V·∫¨T</span>
                    <div style="font-size: 32px; color: #e74c3c; margin-top: 10px;">
                        <span id="timer">0</span> s
                    </div>
                </div>
                <div class="info-box" style="text-align: center; font-size: 20px;">
                <div id="colorOrderBox" 
                    style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 8px; font-weight: bold;">
                    V·∫≠t m√†u --- th·ª© ---
                </div>
                </div>

                <div class="button-container">
                    <button class="btn btn-reset" onclick="resetSystem()" disabled id="resetBtn">
                        üîÑ RESET
                    </button>
                    <button class="btn btn-export" onclick="exportData()" disabled id="exportBtn">
                        üì• XU·∫§T FILE
                    </button>
                </div>
            </div>

            <div class="right-panel">
                <div class="chart-container">
                    <div class="chart-title">üìä BI·ªÇU ƒê·ªí TR·ªòN T·ªîNG S·ªê V·∫¨T</div>
                    <canvas id="pieChart" width="300" height="300"></canvas>
                    
                    <ul class="stats-list">
                        <li class="stats-item red">
                            <span class="color-label">
                                <span class="color-dot" style="background: #e74c3c;"></span>
                                ƒê·ªé:
                            </span>
                            <span id="redCount">0</span>
                        </li>
                        <li class="stats-item green">
                            <span class="color-label">
                                <span class="color-dot" style="background: #2ecc71;"></span>
                                L·ª§C:
                            </span>
                            <span id="greenCount">0</span>
                        </li>
                        <li class="stats-item blue">
                            <span class="color-label">
                                <span class="color-dot" style="background: #3498db;"></span>
                                LAM:
                            </span>
                            <span id="blueCount">0</span>
                        </li>
                        <li class="stats-item yellow">
                            <span class="color-label">
                                <span class="color-dot" style="background: #f1c40f;"></span>
                                V√ÄNG:
                            </span>
                            <span id="yellowCount">0</span>
                        </li>
                        <li class="stats-item black">
                            <span class="color-label">
                                <span class="color-dot" style="background: #2c3e50;"></span>
                                ƒêEN:
                            </span>
                            <span id="blackCount">0</span>
                        </li>
                        <li class="stats-item white">
                            <span class="color-label">
                                <span class="color-dot" style="background: #ecf0f1;"></span>
                                TR·∫ÆNG:
                            </span>
                            <span id="whiteCount">0</span>
                        </li>
                        <li class="stats-item total">
                            <span class="color-label">
                                <strong>üì¶ T·ªîNG:</strong>
                            </span>
                            <strong id="totalCount">0</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, get, remove, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ==========================================
        // C·∫§U H√åNH FIREBASE - NH·∫¨P TH√îNG TIN C·ª¶A B·∫†N ·ªû ƒê√ÇY
        // ==========================================
        const firebaseConfig = {
                    apiKey: "AIzaSyBgzRsUUpotAw230h8JTthlEx_edM41oqI",
                    databaseURL: "https://doan2-77a41-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "doan2-77a41"
                };
        // ==========================================

        // Bi·∫øn to√†n c·ª•c
        window.firebaseApp = null;
        window.database = null;
        window.isConnected = false;
        
        const colorMapping = {
    // CHU·∫®N
    'ƒê·ªé':   { hex: '#e74c3c', key: 'red' },
    'L·ª§C':  { hex: '#2ecc71', key: 'green' },
    'LAM':  { hex: '#3498db', key: 'blue' },
    'V√ÄNG': { hex: '#f1c40f', key: 'yellow' },
    'ƒêEN':  { hex: '#2c3e50', key: 'black' },
    'TR·∫ÆNG':{ hex: '#ecf0f1', key: 'white' },

    // KH√îNG D·∫§U / UPPER
    'DO':   { hex: '#e74c3c', key: 'red' },
    'LUC':  { hex: '#2ecc71', key: 'green' },
    'VANG': { hex: '#f1c40f', key: 'yellow' },
    'DEN':  { hex: '#2c3e50', key: 'black' },
    'TRANG':{ hex: '#ecf0f1', key: 'white' },

    // VI·∫æT HOA CH·ªÆ C√ÅI ƒê·∫¶U (gi·ªëng Firebase)
    'Den':  { hex: '#2c3e50', key: 'black' },
    'Trang':{ hex: '#ecf0f1', key: 'white' },
    'Vang': { hex: '#f1c40f', key: 'yellow' },
    'Do':   { hex: '#e74c3c', key: 'red' },
    'Luc':  { hex: '#2ecc71', key: 'green' },
    'Lam':  { hex: '#3498db', key: 'blue' },

    // ‚ûï TH√äM 6 D·∫†NG "xanh l√° / xanh lam"
    'xanh l√°':  { hex: '#2ecc71', key: 'green' },
    'XANH L√Å':  { hex: '#2ecc71', key: 'green' },
    'Xanh l√°':  { hex: '#2ecc71', key: 'green' },

    'xanh lam': { hex: '#3498db', key: 'blue' },
    'XANH LAM': { hex: '#3498db', key: 'blue' },
    'Xanh lam': { hex: '#3498db', key: 'blue' },

    'xanh d∆∞∆°ng': { hex: '#3498db', key: 'blue' },
    'XANH D∆Ø∆†NG': { hex: '#3498db', key: 'blue' },
    'Xanh d∆∞∆°ng': { hex: '#3498db', key: 'blue' },

    'xanh duong': { hex: '#3498db', key: 'blue' },
    'XANH DUONG': { hex: '#3498db', key: 'blue' },
    'Xanh Duong': { hex: '#3498db', key: 'blue' },

    'Do':    { key: 'red',    hex: '#e74c3c' },
    'Luc':   { key: 'green',  hex: '#2ecc71' },
    'Lam':   { key: 'blue',   hex: '#3498db' },
    'Vang':  { key: 'yellow', hex: '#f1c40f' },
    'Den':   { key: 'black',  hex: '#2c3e50' },
    'Trang': { key: 'white',  hex: '#ecf0f1' }

};


        let stats = {
            red: 0,
            green: 0,
            blue: 0,
            yellow: 0,
            black: 0,
            white: 0,
            total: 0
        };

        let objectHistory = [];
        let objectCount = 0;
        let currentTimer = null;
        let timerSeconds = 0;
        let lastDetectedState = false;
        let processedLogs = new Set(); // ƒê·ªÉ tr√°nh x·ª≠ l√Ω tr√πng log

        // T·ª± ƒë·ªông k·∫øt n·ªëi Firebase khi trang load
        async function initFirebase() {
            console.log('üîÑ ƒêang kh·ªüi t·∫°o Firebase...');
            console.log('Config:', firebaseConfig);
            
            try {
                // Ki·ªÉm tra config
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    throw new Error("Ch∆∞a c·∫•u h√¨nh Firebase! Vui l√≤ng thay th·∫ø th√¥ng tin trong code.");
                }

                console.log('üì° ƒêang k·∫øt n·ªëi Firebase...');
                window.firebaseApp = initializeApp(firebaseConfig);
                window.database = getDatabase(window.firebaseApp);
                
                console.log('‚úÖ Firebase App ƒë√£ kh·ªüi t·∫°o');
                
                // Test k·∫øt n·ªëi v·ªõi timeout
                const testRef = ref(window.database, '/');
                console.log('üîç ƒêang test k·∫øt n·ªëi database...');
                
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: Kh√¥ng th·ªÉ k·∫øt n·ªëi sau 10 gi√¢y')), 10000)
                );
                
                const getData = get(testRef);
                
                await Promise.race([getData, timeout]);
                
                console.log('‚úÖ K·∫øt n·ªëi database th√†nh c√¥ng!');

                window.isConnected = true;
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('connectionStatus').innerHTML = `
                    <span class="status-dot" style="background: #3c3;"></span>
                    <span>‚úÖ ƒê√£ k·∫øt n·ªëi Firebase - ƒêang l·∫Øng nghe d·ªØ li·ªáu...</span>
                `;
                
                document.getElementById('resetBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;

                // B·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu
                listenToFirebase();

                console.log('üéß ƒê√£ b·∫Øt ƒë·∫ßu l·∫Øng nghe d·ªØ li·ªáu t·ª´ Firebase');
            } catch (error) {
                console.error('‚ùå L·ªói Firebase:', error);
                document.getElementById('connectionStatus').className = 'connection-status status-disconnected';
                document.getElementById('connectionStatus').innerHTML = `
                    <span class="status-dot" style="background: #c33;"></span>
                    <span>‚ùå L·ªói: ${error.message}</span>
                `;
                
                // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
                console.log('%cüìã H∆Ø·ªöNG D·∫™N S·ª¨A L·ªñI:', 'color: blue; font-size: 16px; font-weight: bold');
                console.log('1. M·ªü Firebase Console: https://console.firebase.google.com');
                console.log('2. Ch·ªçn project c·ªßa b·∫°n');
                console.log('3. V√†o Project Settings (bi·ªÉu t∆∞·ª£ng b√°nh rƒÉng) ‚Üí General');
                console.log('4. Scroll xu·ªëng ph·∫ßn "Your apps" ‚Üí Web app');
                console.log('5. Copy to√†n b·ªô firebaseConfig v√† thay th·∫ø trong code');
                console.log('6. ƒê·∫£m b·∫£o Realtime Database ƒë√£ ƒë∆∞·ª£c t·∫°o v√† c√≥ rules ph√π h·ª£p');
            }
        }

        // L·∫Øng nghe d·ªØ li·ªáu t·ª´ Firebase
        function listenToFirebase() {
            // L·∫Øng nghe tr·∫°ng th√°i ph√°t hi·ªán t·ª´ device/detect
            const detectRef = ref(window.database, 'device/detect');
            
            onValue(detectRef, (snapshot) => {
                const detectData = snapshot.val();
                if (detectData) {
                    console.log('Firebase detect data:', detectData);
                    processDetectStatus(detectData);
                }
            }, (error) => {
                console.error('Firebase detect read error:', error);
            });

            // L·∫Øng nghe log m√†u t·ª´ color_log
            const colorLogRef = ref(window.database, 'color_log');
            
            onValue(colorLogRef, (snapshot) => {
            const colorLogData = snapshot.val();

            if (colorLogData) {
                processColorLog(colorLogData);
            } else {
                // color_log b·ªã x√≥a / r·ªóng -> reset UI th·ªëng k√™ + hi·ªÉn th·ªã g·∫ßn nh·∫•t
                stats = { red:0, green:0, blue:0, yellow:0, black:0, white:0, total:0 };
                objectHistory = [];
                objectCount = 0;

                document.getElementById('objectNumber').textContent = '0';
                document.getElementById('objectColor').textContent = '---';
                document.getElementById('objectColor').style.color = 'inherit';
                document.getElementById('colorDisplay').style.background = '#f0f0f0';
                document.getElementById('movingObject').style.background = '#ccc';

                const orderBox = document.getElementById('colorOrderBox');
                orderBox.textContent = `V·∫≠t m√†u ${latestObject.mau} th·ª© ${latestObject.soThuTuMau}`;

                orderBox.style.color = 'inherit';

                updateStats(); // s·∫Ω v·∫Ω l·∫°i bi·ªÉu ƒë·ªì + reset counts
            }
            });

        }

        // X·ª≠ l√Ω tr·∫°ng th√°i ph√°t hi·ªán t·ª´ device/detect
        function processDetectStatus(detectData) {
            const detected = detectData.detected === true || detectData.detected === 'true';
            const time = detectData.time || '';

            console.log(`üîç Tr·∫°ng th√°i ph√°t hi·ªán: ${detected}, Th·ªùi gian: ${time}`);

            // X·ª≠ l√Ω tr·∫°ng th√°i ph√°t hi·ªán
            const detectionStatus = document.getElementById('detectionStatus');
            if (detected && !lastDetectedState) {
                // V·∫≠t m·ªõi ƒë∆∞·ª£c ph√°t hi·ªán
                detectionStatus.classList.add('active');
                startTimer();
                console.log('‚úÖ Ph√°t hi·ªán v·∫≠t m·ªõi!');
            } else if (!detected && lastDetectedState) {
                // V·∫≠t ƒë√£ r·ªùi ƒëi
                detectionStatus.classList.remove('active');
                stopTimer();
                console.log('üëã V·∫≠t ƒë√£ r·ªùi ƒëi');
            }

            lastDetectedState = detected;
        }

        // X·ª≠ l√Ω d·ªØ li·ªáu m√†u t·ª´ color_log
        function processColorLog(colorLogData) {
            // Chuy·ªÉn object th√†nh array v√† s·∫Øp x·∫øp theo th·ªùi gian
            const logEntries = Object.entries(colorLogData).sort((a, b) => {
                return a[0].localeCompare(b[0]); // S·∫Øp x·∫øp theo key (timestamp)
            });

            console.log(`üìã T·ªïng s·ªë log: ${logEntries.length}`);

            // Reset stats tr∆∞·ªõc khi ƒë·∫øm l·∫°i
            // Reset stats tr∆∞·ªõc khi ƒë·∫øm l·∫°i
            stats = {
                red: 0,
                green: 0,
                blue: 0,
                yellow: 0,
                black: 0,
                white: 0,
                total: 0
            };

            // X√≥a objectHistory c≈©
            objectHistory = [];
            let newObjectCount = 0;
            let colorOrder = {
                red: 0, green: 0, blue: 0, yellow: 0, black: 0, white: 0
            };
            
            // Duy·ªát qua t·∫•t c·∫£ c√°c log
            logEntries.forEach(([logId, logData]) => {
                const color = logData.color;
                const time = logData.time;
                const normalized = normalizeColorName(color);
                
                // Map m√†u
                let mappedColor = null;
                if (colorMapping[color]) {
                    mappedColor = color;
                }
                // 2. ƒë√∫ng chu·ªói normalize
                else if (colorMapping[normalized]) {
                    mappedColor = normalized;
                }
                // 3. uppercase
                else if (colorMapping[color.toUpperCase()]) {
                    mappedColor = color.toUpperCase();
                }

                if (mappedColor && colorMapping[mappedColor]) {
                    const colorInfo = colorMapping[mappedColor];
                    
                    // TƒÉng th·ª© t·ª± m√†u TR∆Ø·ªöC KHI l∆∞u v√†o history
                    colorOrder[colorInfo.key]++;
                    
                    // ƒê·∫øm s·ªë l∆∞·ª£ng
                    stats[colorInfo.key]++;
                    stats.total++;
                    newObjectCount++;

                    // L∆∞u v√†o history v·ªõi th·ª© t·ª± m√†u ƒë√£ ƒë∆∞·ª£c tƒÉng
                    objectHistory.push({
                        soThuTu: newObjectCount,
                        mau: color,
                        mauHex: colorInfo.hex,
                        thoiGian: time,
                        logId: logId,
                        soThuTuMau: colorOrder[colorInfo.key],   // ‚úÖ Gi·ªù ƒë√¢y ƒë√£ ƒë∆∞·ª£c tƒÉng tr∆∞·ªõc
                        mauKey: colorInfo.key
                    });

                    console.log(`   ${newObjectCount}. ${mappedColor} (th·ª© ${colorOrder[colorInfo.key]}) - ${time}`);
                }
            });

            // C·∫≠p nh·∫≠t objectCount
            objectCount = newObjectCount;
            document.getElementById('objectNumber').textContent = objectCount;

            // Hi·ªÉn th·ªã m√†u c·ªßa v·∫≠t g·∫ßn nh·∫•t
            if (objectHistory.length > 0) {
                const latestObject = objectHistory[objectHistory.length - 1];
                const objectColorElement = document.getElementById('objectColor');
                objectColorElement.textContent = latestObject.mau;
                objectColorElement.style.color = latestObject.mauHex;
                document.getElementById('colorDisplay').style.background = latestObject.mauHex;
                document.getElementById('movingObject').style.background = latestObject.mauHex;

                // T√≠nh th·ª© t·ª± m√†u n√†y trong to√†n b·ªô l·ªãch s·ª≠
                let sameColorCount = objectHistory.filter(o => o.mauHex === latestObject.mauHex).length;

                // Hi·ªÉn th·ªã "V·∫≠t m√†u X th·ª© Y"
                const orderBox = document.getElementById('colorOrderBox');
                orderBox.textContent = `V·∫≠t m√†u ${latestObject.mau} th·ª© ${sameColorCount}`;
                orderBox.style.color = latestObject.mauHex;

            }

            // C·∫≠p nh·∫≠t giao di·ªán
            updateStats();
        }

        function normalizeColorName(rawColor) {
                if (!rawColor) return '';

                // b·ªè d·∫•u + vi·∫øt hoa
                let c = rawColor
                    .trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .toUpperCase();

                // üëâ XANH L√Å
                if (c.includes("XANH") && c.includes("LA"))  return "xanh l√°";

                // üëâ XANH LAM ho·∫∑c XANH D∆Ø∆†NG / XANH DUONG
                if (c.includes("XANH") && (c.includes("LAM") || c.includes("DUONG"))) {
                    return "xanh lam";
                }

                return rawColor;
            }


        // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ Firebase (deprecated - gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch)
        function processFirebaseData(data) {
            // Function n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch, nh∆∞ng kh√¥ng d√πng n·ªØa
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ counter trong Firebase (deprecated - gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch)
        function updateStatsFromCounter(counterData) {
            // Function n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch, nh∆∞ng kh√¥ng d√πng n·ªØa
        }

        // X·ª≠ l√Ω v·∫≠t m·ªõi (deprecated - gi·ªØ ƒë·ªÉ t∆∞∆°ng th√≠ch)
        function processNewObject(colorName, time) {
            const colorInfo = colorMapping[color];
            if (!colorInfo) return;
            colorOrder[colorInfo.key]++;
            // L∆∞u l·ªãch s·ª≠
            objectHistory.push({
                soThuTuMau: colorOrder[colorInfo.key],
                mau: colorName,
                mauHex: colorInfo.hex,
                thoiGian: time || new Date().toLocaleString('vi-VN')
            });

            // C·∫≠p nh·∫≠t giao di·ªán hi·ªÉn th·ªã m√†u hi·ªán t·∫°i
            const objectColorElement = document.getElementById('objectColor');
            objectColorElement.textContent = colorName;
            objectColorElement.style.color = colorInfo.hex;
            
            document.getElementById('colorDisplay').style.background = colorInfo.hex;
            document.getElementById('movingObject').style.background = colorInfo.hex;

            // Kh√¥ng c·∫≠p nh·∫≠t stats ·ªü ƒë√¢y n·ªØa v√¨ s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ counter
            console.log('‚úÖ ƒê√£ x·ª≠ l√Ω v·∫≠t m·ªõi:', colorName);
        }

        // ƒê·∫øm th·ªùi gian
        function startTimer() {
            if (currentTimer) return;

            timerSeconds = 0;

            document.getElementById('timer').textContent = Math.max(0, timerSeconds - 2);

            currentTimer = setInterval(() => {
                timerSeconds++;

                const displayTime = Math.max(0, timerSeconds - 2);
                document.getElementById('timer').textContent = displayTime;

            }, 1000);
        }


        function stopTimer() {
            if (currentTimer) {
                clearInterval(currentTimer);
                currentTimer = null;
            }
        }

        // V·∫Ω bi·ªÉu ƒë·ªì
        function drawPieChart() {
            const canvas = document.getElementById('pieChart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 120;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = stats.total || 1;
            let currentAngle = -Math.PI / 2;

            const data = [
                { count: stats.red, color: '#e74c3c' },
                { count: stats.green, color: '#2ecc71' },
                { count: stats.blue, color: '#3498db' },
                { count: stats.yellow, color: '#f1c40f' },
                { count: stats.black, color: '#2c3e50' },
                { count: stats.white, color: '#ecf0f1' }
            ];

            data.forEach(item => {
                const sliceAngle = (item.count / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.stroke();

                currentAngle += sliceAngle;
            });
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('redCount').textContent = stats.red;
            document.getElementById('greenCount').textContent = stats.green;
            document.getElementById('blueCount').textContent = stats.blue;
            document.getElementById('yellowCount').textContent = stats.yellow;
            document.getElementById('blackCount').textContent = stats.black;
            document.getElementById('whiteCount').textContent = stats.white;
            document.getElementById('totalCount').textContent = stats.total;
            drawPieChart();
        }

        // Reset h·ªá th·ªëng
        window.resetSystem = async function() {
            if (!window.isConnected) {
                alert('‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi Firebase!');
                return;
            }

            if (!confirm('üîÑ B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô d·ªØ li·ªáu?\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y s·∫Ω:\n- X√≥a to√†n b·ªô color_log tr√™n Firebase\n- Reset device/detect v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu\n- X√≥a t·∫•t c·∫£ d·ªØ li·ªáu tr√™n web\n\nKh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }

            try {
                console.log('üîÑ ƒêang reset h·ªá th·ªëng...');
                
                // Disable n√∫t reset t·∫°m th·ªùi
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('resetBtn').textContent = 'ƒêang reset...';

                // 1. X√≥a color_log tr√™n Firebase
                const colorLogRef = ref(window.database, 'color_log');
                await remove(colorLogRef);
                console.log('‚úÖ ƒê√£ x√≥a color_log');

                // 2. Reset device/detect v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
                const detectRef = ref(window.database, 'device/detect');
                await set(detectRef, {
                    detected: false,
                    time: new Date().toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }).replace(/\//g, '-').replace(',', '')
                });
                console.log('‚úÖ ƒê√£ reset device/detect');

                // 3. Reset d·ªØ li·ªáu local
                stopTimer();
                
                objectCount = 0;
                stats = {
                    red: 0,
                    green: 0,
                    blue: 0,
                    yellow: 0,
                    black: 0,
                    white: 0,
                    total: 0
                };
                objectHistory = [];
                lastDetectedState = false;
                processedLogs.clear();

                // 4. Reset giao di·ªán
                document.getElementById('detectionStatus').classList.remove('active');
                document.getElementById('objectNumber').textContent = '0';
                document.getElementById('objectColor').textContent = '---';
                document.getElementById('objectColor').style.color = 'inherit';
                document.getElementById('colorDisplay').style.background = '#f0f0f0';
                document.getElementById('movingObject').style.background = '#ccc';
                document.getElementById('timer').textContent = '0';
                const orderBox = document.getElementById('colorOrderBox');
                orderBox.textContent = 'V·∫≠t m√†u --- th·ª© ---';
                orderBox.style.color = 'inherit';

                // (n√™n reset c·∫£ bi·∫øn timerSeconds ƒë·ªÉ ch·∫Øc ch·∫Øn)
                timerSeconds = 0;
                updateStats();
                
                // Enable l·∫°i n√∫t reset
                document.getElementById('resetBtn').disabled = false;
                document.getElementById('resetBtn').textContent = 'üîÑ RESET';
                
                alert('‚úÖ ƒê√£ reset to√†n b·ªô h·ªá th·ªëng!\n\n- ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu tr√™n Firebase\n- ƒê√£ reset giao di·ªán web\n- H·ªá th·ªëng s·∫µn s√†ng ho·∫°t ƒë·ªông');
                
                console.log('‚úÖ Reset ho√†n t·∫•t!');
            } catch (error) {
                console.error('‚ùå L·ªói khi reset:', error);
                alert('‚ùå L·ªói khi reset h·ªá th·ªëng: ' + error.message);
                
                // Enable l·∫°i n√∫t reset
                document.getElementById('resetBtn').disabled = false;
                document.getElementById('resetBtn').textContent = 'üîÑ RESET';
            }
        };

        // Xu·∫•t file
        window.exportData = function() {
            if (stats.total === 0) {
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
                return;
            }

            let csvContent = '\ufeff';
            csvContent += 'B√ÅO C√ÅO H·ªÜ T·ªîNG S·∫¢N PH·∫®M ƒê√É PH√ÇN LO·∫†I\n';
            csvContent += '=============================================\n\n';
            csvContent += 'TH·ªêNG K√ä T·ªîNG QUAN\n';
            csvContent += `T·ªïng s·ªë v·∫≠t: ${stats.total}\n`;
            csvContent += `V·∫≠t m√†u ƒë·ªè: ${stats.red}\n`;
            csvContent += `V·∫≠t m√†u l·ª•c: ${stats.green}\n`;
            csvContent += `V·∫≠t m√†u lam: ${stats.blue}\n`;
            csvContent += `V·∫≠t m√†u v√†ng: ${stats.yellow}\n`;
            csvContent += `V·∫≠t m√†u ƒëen: ${stats.black}\n`;
            csvContent += `V·∫≠t m√†u tr·∫Øng: ${stats.white}\n\n`;
            
            csvContent += 'CHI TI·∫æT T·ª™NG V·∫¨T\n';
            csvContent += 'STT,M√†u,Th·ª© t·ª± m√†u,Th·ªùi gian\n';

            
            objectHistory.forEach(obj => {
            csvContent += `${obj.soThuTu},${obj.mau},${obj.soThuTuMau},${obj.thoiGian}\n`;
            });

            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `BaoCao_SapXepVat_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ ƒê√£ xu·∫•t file b√°o c√°o!\n\nT·ªïng s·ªë v·∫≠t: ${stats.total}\nFile: BaoCao_SapXepVat_${timestamp}.csv`);
        };

        // Kh·ªüi t·∫°o
        drawPieChart();
        
        // T·ª± ƒë·ªông k·∫øt n·ªëi Firebase khi trang load
        initFirebase();
    </script>
</body>
</html>